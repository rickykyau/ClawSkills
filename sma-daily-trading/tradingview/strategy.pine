// @version=5
// SMA Daily Trading Strategy - QQQ Signal â†’ TQQQ Trade
// Run this on TQQQ chart (Daily timeframe)

strategy("SMA Daily Trading - QQQ/TQQQ", overlay=true, 
         initial_capital=10000, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0)

// Parameters
sma_period = input.int(100, "SMA Period", minval=1)
fixed_stop_pct = input.float(10.0, "Fixed Stop %", minval=0.1, step=0.1)
trailing_stop_pct = input.float(15.0, "Trailing Stop %", minval=0.1, step=0.1)

// Get QQQ data for signals
qqq_close = request.security("QQQ", timeframe.period, close)
qqq_sma = ta.sma(qqq_close, sma_period)

// Signal conditions
qqq_above_sma = qqq_close > qqq_sma
qqq_cross_above = ta.crossover(qqq_close, qqq_sma)
qqq_cross_below = ta.crossunder(qqq_close, qqq_sma)

// Track position
var float entry_price = na
var float highest_since_entry = na
var bool in_position = false
var bool signal_memory = false

// Calculate stops
fixed_stop = entry_price * (1 - fixed_stop_pct / 100)
trailing_stop = highest_since_entry * (1 - trailing_stop_pct / 100)
effective_stop = math.max(nz(fixed_stop, 0), nz(trailing_stop, 0))

// Update highest price since entry
if in_position
    highest_since_entry := math.max(highest_since_entry, high)

// Entry logic
buy_signal = qqq_cross_above or (signal_memory and qqq_above_sma)

if buy_signal and not in_position
    strategy.entry("Long", strategy.long)
    entry_price := close
    highest_since_entry := high
    in_position := true
    signal_memory := false

// Exit logic - SMA cross below
if qqq_cross_below and in_position
    strategy.close("Long", comment="SMA Exit")
    in_position := false
    signal_memory := false
    entry_price := na
    highest_since_entry := na

// Exit logic - Stop hit (check both fixed and trailing)
if in_position and close <= effective_stop
    stop_type = trailing_stop >= fixed_stop ? "Trail Stop" : "Fixed Stop"
    strategy.close("Long", comment=stop_type)
    signal_memory := qqq_above_sma  // Set signal memory if QQQ still above SMA
    in_position := false
    entry_price := na
    highest_since_entry := na

// Plot signals
plot(qqq_sma, "QQQ SMA", color=color.orange, linewidth=2)
plotshape(qqq_cross_above, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(qqq_cross_below, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// Plot stop levels when in position
plot(in_position ? fixed_stop : na, "Fixed Stop", color=color.red, style=plot.style_linebr)
plot(in_position ? trailing_stop : na, "Trailing Stop", color=color.purple, style=plot.style_linebr)
plot(in_position ? effective_stop : na, "Effective Stop", color=color.blue, style=plot.style_linebr, linewidth=2)

// Background color when in position
bgcolor(in_position ? color.new(color.green, 90) : na)

// Info table
var table info = table.new(position.top_right, 2, 6, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(info, 0, 0, "QQQ Close", text_color=color.black)
    table.cell(info, 1, 0, str.tostring(qqq_close, "#.##"), text_color=color.black)
    table.cell(info, 0, 1, "QQQ SMA", text_color=color.black)
    table.cell(info, 1, 1, str.tostring(qqq_sma, "#.##"), text_color=color.black)
    table.cell(info, 0, 2, "Above SMA", text_color=color.black)
    table.cell(info, 1, 2, qqq_above_sma ? "YES" : "NO", text_color=qqq_above_sma ? color.green : color.red)
    table.cell(info, 0, 3, "In Position", text_color=color.black)
    table.cell(info, 1, 3, in_position ? "YES" : "NO", text_color=in_position ? color.green : color.gray)
    table.cell(info, 0, 4, "Fixed Stop", text_color=color.black)
    table.cell(info, 1, 4, in_position ? str.tostring(fixed_stop, "#.##") : "-", text_color=color.red)
    table.cell(info, 0, 5, "Trail Stop", text_color=color.black)
    table.cell(info, 1, 5, in_position ? str.tostring(trailing_stop, "#.##") : "-", text_color=color.purple)
